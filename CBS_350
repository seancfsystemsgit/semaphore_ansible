---
- name: Backup Cisco CBS350 configurations
  hosts: cbs_switches
  gather_facts: no
  vars:
    backup_dir: "backups"
    timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  vars_prompt:
    - name: ansible_user
      prompt: "Enter switch username"
      private: no
    - name: ansible_password
      prompt: "Enter switch password"
      private: yes

  tasks:
    - name: Ensure backup directory exists
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Get full running configuration
      ansible.netcommon.cli_command:
        command: more system:running-config
      register: running_config

    - name: Save running config to local file
      copy:
        content: "{{ running_config.stdout[0] }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}-running-config-{{ timestamp }}.txt"

    - name: Get full startup configuration
      ansible.netcommon.cli_command:
        command: more system:startup-config
      register: startup_config

    - name: Save startup config to local file
      copy:
        content: "{{ startup_config.stdout[0] }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}-startup-config-{{ timestamp }}.txt"

    - name: Print confirmation
      debug:
        msg: "Backup completed for {{ inventory_hostname }}. Files saved in {{ backup_dir }}/"
